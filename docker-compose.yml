# Variables set to use EXT prefix for all external facing ports (to avoid collions)
# The variables without EXT prefix are internal or global (passwords, etc)
# Defaults are provided for some parameters, but mostly they come from .env.
# DB image is provided from .env, just in case you wish to use the pg17 or custom
# Ideally you don't need to edit this file at all 

# Project name is parameterized to allow multiple instances running in parallel
name: ${PROJECT_NAME}

x-common: &common
  # Network names parameterized
  networks:
    - internal
  env_file: .env
  restart: unless-stopped

services:
  studio:
    <<: *common
    image: ghcr.io/webysther/supabase-studio:2026.01.27
    # Container name parameterized to avoid collision
    container_name: ${PROJECT_NAME}-studio
    # Studio display settings - parameterized for multi-instance clarity
    environment:
      STUDIO_DEFAULT_ORGANIZATION: ${STUDIO_DEFAULT_ORGANIZATION:-Default Organization}
      STUDIO_DEFAULT_PROJECT: ${STUDIO_DEFAULT_PROJECT:-Default Project}
    depends_on:
      analytics:
        condition: service_healthy
    volumes:
      # Volume references use static keys
      - snippets:/app/snippets
      - functions:/app/edge-functions

  kong:
    <<: *common
    image: ghcr.io/webysther/supabase-kong:2.8.1
    # Container name parameterized to avoid collision
    container_name: ${PROJECT_NAME}-kong
    environment:
      DASHBOARD_USERNAME: ${DASHBOARD_USERNAME}
    ulimits:
      nofile:
        soft: 4096
        hard: 4096
    networks:
      # Network references use static keys
      - default
      - internal
    ports:
      # External port parameterized - internal port stays 8000
      - ${EXT_KONG_HTTP_PORT:-8000}:8000/tcp
    depends_on:
      analytics:
        condition: service_healthy

  auth:
    <<: *common
    image: ghcr.io/webysther/supabase-auth:2.185.0
    # Container name parameterized to avoid collision
    container_name: ${PROJECT_NAME}-auth
    depends_on:
      db:
        condition: service_healthy
      analytics:
        condition: service_healthy

  rest:
    <<: *common
    image: ghcr.io/webysther/supabase-rest:14.3
    # Container name parameterized to avoid collision
    container_name: ${PROJECT_NAME}-rest
    depends_on:
      db:
        condition: service_healthy
      analytics:
        condition: service_healthy

  realtime:
    <<: *common
    image: ghcr.io/webysther/supabase-realtime:2.72.0
    # Container name parameterized to avoid collision
    container_name: ${PROJECT_NAME}-realtime
    ulimits:
      nofile:
        soft: 10000
        hard: 10000
    depends_on:
      db:
        condition: service_healthy
      analytics:
        condition: service_healthy

  storage:
    <<: *common
    image: ghcr.io/webysther/supabase-storage:1.37.1
    # Container name parameterized to avoid collision
    container_name: ${PROJECT_NAME}-storage
    volumes:
      # Volume reference uses static key
      - storage:/var/lib/storage
    depends_on:
      db:
        condition: service_healthy
      rest:
        condition: service_started
      imgproxy:
        condition: service_started

  imgproxy:
    <<: *common
    image: ghcr.io/webysther/supabase-img:3.30.1
    # Container name parameterized to avoid collision
    container_name: ${PROJECT_NAME}-imgproxy
    volumes:
      # Volume reference uses static key
      - storage:/var/lib/storage

  meta:
    <<: *common
    image: ghcr.io/webysther/supabase-meta:0.95.2
    # Container name parameterized to avoid collision
    container_name: ${PROJECT_NAME}-meta
    depends_on:
      db:
        condition: service_healthy
      analytics:
        condition: service_healthy

  functions:
    <<: *common
    image: ghcr.io/webysther/supabase-functions:1.70.0
    # Container name parameterized to avoid collision
    container_name: ${PROJECT_NAME}-edge-functions
    volumes:
      # Volume reference uses static key
      - functions:/home/deno/functions
    depends_on:
      analytics:
        condition: service_healthy

  analytics:
    <<: *common
    image: ghcr.io/webysther/supabase-analytics:1.30.3
    # Container name parameterized to avoid collision
    container_name: ${PROJECT_NAME}-analytics
    #ports:
    # Optional analytics port - uncomment and parameterize if needed
    #  - ${EXT_ANALYTICS_PORT}:4000
    depends_on:
      db:
        condition: service_healthy

  db:
    <<: *common
    # DB image is parameterized to allow you to use other images
    image: ${POSTGRES_IMAGE}
    # Container name parameterized to avoid collision
    container_name: ${PROJECT_NAME}-db
    environment:
      # Database settings - internal port is always 5432
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-postgres}
    volumes:
      # Volume references use static keys
      - db:/var/lib/postgresql/data
      - db-config:/etc/postgresql-custom
    depends_on:
      vector:
        condition: service_healthy

  vector:
    <<: *common
    image: ghcr.io/webysther/supabase-vector:0.28.1
    # Container name parameterized to avoid collision
    container_name: ${PROJECT_NAME}-vector
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    security_opt:
      - "label=disable"

  supavisor:
    <<: *common
    image: ghcr.io/webysther/supabase-supavisor:2.7.4
    # Container name parameterized to avoid collision
    container_name: ${PROJECT_NAME}-pooler
    ports:
      # External ports parameterized - internal ports stay 5432/6543
      - ${EXT_POSTGRES_PORT:-5432}:5432
      - ${EXT_POOLER_PORT:-6543}:6543
    depends_on:
      db:
        condition: service_healthy
      analytics:
        condition: service_healthy

volumes:
  # Static keys with parameterized names to avoid collision
  db:
    name: ${PROJECT_NAME}-db
  db-config:
    name: ${PROJECT_NAME}-db-config
  functions:
    name: ${PROJECT_NAME}-functions
  snippets:
    name: ${PROJECT_NAME}-snippets
  storage:
    name: ${PROJECT_NAME}-storage

networks:
  # Static keys with parameterized names to avoid collision
  default:
    name: ${PROJECT_NAME}
  internal:
    name: ${PROJECT_NAME}-internal

